name: Release Module
on:
  release:
    types: [published]
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create module zip
        run: |
          zip -r axeom-hud-pf2e.zip . \
            -x "*.git*" \
            -x "*.DS_Store" \
            -x "node_modules/*" \
            -x ".github/*"

      - name: Upload zip to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./axeom-hud-pf2e.zip
          asset_name: axeom-hud-pf2e.zip
          asset_content_type: application/zip

      - name: Upload module.json to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./module.json
          asset_name: module.json
          asset_content_type: application/json

      - name: Notify Foundry Package Release API
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          FOUNDRY_API_KEY: ${{ secrets.FOUNDRY_API_KEY }}
        run: |
          curl -X POST "https://api.foundryvtt.com/_api/packages/release_version/" \
            -H "Content-Type: application/json" \
            -H "Authorization: ${FOUNDRY_API_KEY}" \
            -d "{
              \"id\": \"axeom-hud-pf2e\",
              \"release\": {
                \"version\": \"${VERSION}\",
                \"manifest\": \"https://github.com/mattermill/axeom-hud-pf2e/releases/download/v${VERSION}/module.json\",
                \"notes\": \"https://github.com/mattermill/axeom-hud-pf2e/releases/tag/v${VERSION}\",
                \"compatibility\": {
                  \"minimum\": \"10\",
                  \"verified\": \"13\"
                }
              }
            }"
